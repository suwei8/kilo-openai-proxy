# Kilo OpenAI Proxy — 开发记录（2025-09-02-03）

> 本条记录承接《dev-log-2025-09-02.md》，聚焦：服务常驻与测试分离、端到端验证结果、`FORCE_ENTER_ONLY` 提交流程的行为澄清与集成、以及下一步“可安全精简”的计划。

## 版本快照

- 建议语义版本：v0.1.2
- 主要变更类型：fix/ops/docs（运行与验证流程梳理；提交主链路开关澄清；无破坏性接口改动）
- 关键文件：
  - server.js（提交主链路根据 `FORCE_ENTER_ONLY` 分流；基线 baseline 贯穿）
  - test/test_once.mjs（非流式回归）
  - test/test_stream.mjs（流式 SSE 回归）
  - docs/dev-log-2025-09-02-03.md（新增）
- 运行环境：
  - Node.js：v20.19.4（用户环境）
  - Playwright Chromium：build 1181（by Playwright）
  - 服务端口：http://127.0.0.1:8033

---

## 前情摘要（承接 v0.1.1）

- 上一版（建议 v0.1.1）已完成“基于 baseline 阻止复读上一次回答”的核心修复：
  1) `submitPrompt()` 返回提交前的气泡数 baseline；
  2) 流式与非流式读取器仅读取 baseline 后新增气泡；
  3) 未触发生成时明确返回 `502 submit_not_started` 或 `no_text_captured`；
  4) 新增 `/peek?base=` 便于基线对齐调试。
- 同时，在 `.env` 中建议了 `FORCE_ENTER_ONLY=false` 的默认运行策略，以允许“回车 → 按钮兜底”的稳健提交流。
---

## 本次新增与修复（本地验证链路打通）

1) 运行方式调整（避免误关服务）

- 将服务与测试分离到不同终端：保持一个终端后台 `npm start` 持续监听 8033；在其他终端执行 `node test\test_once.mjs` 和 `node test\test_stream.mjs`。
- 排查并修正“在同一终端执行测试导致服务被中断”的误操作，避免 `ECONNREFUSED 127.0.0.1:8033`。

2) 提交主链路与 `FORCE_ENTER_ONLY` 行为澄清

- `.env` 中的 `FORCE_ENTER_ONLY` 已接入主链路：
  - `false`（默认）：先尝试回车提交，若未启动则按钮兜底（含一次兜底点击）；
  - `true`：仅通过回车提交，不监控按钮，不进行按钮兜底（用于专项验证）。
- 保持 baseline 方案：不论何种提交方式，均以提交前气泡数作为基线，避免复读。

3) 回归测试结果

- 非流式：`node test\test_once.mjs` → 能正确返回当前问题的答案（非上一次）；
- 流式（SSE）：`node test\test_stream.mjs` → 能连续两次提问且第二次不会复读第一次，输出按差量增量推送，末尾 `[DONE]`；
- `/status` → `{ ok: true, busy: false }`，服务处于可用且空闲状态。

4) 观测性与调试

- `/peek?base=` 可用于现场核对基线；
- 后续计划考虑将关键运行时位（baseline、最后抓取时间、是否 busy、选择器命中情况）纳入 `/debug`（仅在 `DEBUG=1` 时暴露）。
---

## 使用与验证清单（复现指南）

1. 启动服务（常驻）：
   - 在一个终端执行：`npm start`（保持运行，不要复用该终端做其他命令）。
2. 健康检查：
   - `Invoke-RestMethod -Uri http://127.0.0.1:8033/status` → 期待 `ok: true`、`busy: false`。
3. 非流式验证：
   - `node test\test_once.mjs`；随后立即再次执行一次，确认不会复读。
4. 流式（SSE）验证：
   - `node test\test_stream.mjs`；随后再次执行，确认不会复读且以 `[DONE]` 收束。
5. 行为切换（可选）：
   - 在 `.env` 中将 `FORCE_ENTER_ONLY=true`，重启服务，重复 3/4 步用于“仅回车提交”专项验证。

---

## 已知风险与建议

- 页面 DOM 变化仍可能影响选择器：建议在 `/debug` 中持续检测 `answerArea.root/markdown` 命中情况；
- 长回答时限：`MAX_ANSWER_MS` 过小时可能截断，生产建议以 `stream:true` 为主；
- 并发：当前仅单实例单页串行，后续可考虑页池/多上下文以提升吞吐。

---

## 变更摘要（建议用于本次提交信息）

chore(docs+ops): 本地服务常驻与测试分离，验证非流式/流式链路；澄清并接入 FORCE_ENTER_ONLY 提交流行为

- 将服务与测试命令分离到不同终端，消除 ECONNREFUSED；
- 验证 test_once.mjs 与 test_stream.mjs：非流式返回正确答案；流式增量输出并稳定 `[DONE]`；
- 明确 FORCE_ENTER_ONLY 的两种模式并确保 baseline 贯穿读取，避免复读；
- 补充 dev-log-2025-09-02-03.md 文档与复现步骤。
